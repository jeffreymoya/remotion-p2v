name: E2E Tests

on:
  # Run on pull requests to main
  pull_request:
    branches: [main]

  # Run on pushes to main
  push:
    branches: [main]

  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (full or preview)'
        required: false
        default: 'preview'
        type: choice
        options:
          - full
          - preview

# Prevent concurrent runs on the same branch
concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  TEST_MODE: ${{ github.event.inputs.test_mode || 'preview' }}

jobs:
  # Job 1: Validate API Keys
  validate-api-keys:
    name: Validate API Keys
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API keys
        env:
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          bash tests/scripts/check-api-keys.sh

  # Job 2: Run Unit and Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: validate-api-keys

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run schema tests
        run: npm run test:schema

      - name: Run timeline tests
        run: npm run test:timeline

      - name: Run aspect processor tests
        run: npm run test:aspect

      - name: Run word timing tests
        run: npm run test:word-timing

  # Job 3: Run Edge Case Tests
  edge-case-tests:
    name: Edge Case Tests
    runs-on: ubuntu-latest
    needs: validate-api-keys

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run edge case tests
        env:
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: npm run test:edge-cases

  # Job 4: Run Full E2E Tests (Preview Mode)
  e2e-tests-preview:
    name: E2E Tests (Preview)
    runs-on: ubuntu-latest
    needs: [validate-api-keys, unit-tests]
    if: ${{ github.event.inputs.test_mode == 'preview' || github.event.inputs.test_mode == '' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install system dependencies (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run full pipeline test (preview)
        env:
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          TEST_PREVIEW_ONLY: 'true'
          TEST_IGNORE_RATE_LIMITS: 'false'
        run: npm run test:e2e:fast

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-preview-artifacts
          path: |
            tests/reports/e2e/
            public/projects/
          retention-days: 7

  # Job 5: Run Individual Stage Tests
  stage-tests:
    name: Stage Tests (${{ matrix.stage }})
    runs-on: ubuntu-latest
    needs: [validate-api-keys, unit-tests]
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        stage:
          - discover
          - curate
          - refine
          - script
          - gather
          - build
          - render

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install system dependencies (ffmpeg)
        if: matrix.stage == 'render'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run ${{ matrix.stage }} stage test
        env:
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          TEST_PREVIEW_ONLY: 'true'
        run: npm run test:e2e:stage:${{ matrix.stage }}

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: stage-${{ matrix.stage }}-artifacts
          path: |
            tests/reports/e2e/
            public/projects/
          retention-days: 7

  # Job 6: Run Full E2E Tests (Full Mode - Manual Only)
  e2e-tests-full:
    name: E2E Tests (Full)
    runs-on: ubuntu-latest
    needs: [validate-api-keys, unit-tests]
    if: ${{ github.event.inputs.test_mode == 'full' }}
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install system dependencies (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run full pipeline test (full render)
        env:
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          TEST_PREVIEW_ONLY: 'false'
          TEST_IGNORE_RATE_LIMITS: 'false'
        run: npm run test:e2e

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-full-artifacts
          path: |
            tests/reports/e2e/
            public/projects/
          retention-days: 14

      - name: Upload rendered video
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-video
          path: public/projects/*/output.mp4
          retention-days: 14

  # Job 7: Test Report Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, edge-case-tests, e2e-tests-preview, stage-tests]
    if: always()

    steps:
      - name: Generate test summary
        run: |
          echo "## E2E Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Edge Case Tests: ${{ needs.edge-case-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests (Preview): ${{ needs.e2e-tests-preview.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stage Tests: ${{ needs.stage-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Mode" >> $GITHUB_STEP_SUMMARY
          echo "Mode: ${{ env.TEST_MODE }}" >> $GITHUB_STEP_SUMMARY
