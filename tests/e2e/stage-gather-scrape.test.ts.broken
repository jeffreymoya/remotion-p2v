#!/usr/bin/envâœ“node
/**
âœ“*âœ“Stageâœ“5:âœ“Gatherâœ“E2Eâœ“Testâœ“withâœ“--scrapeâœ“Flag
âœ“*
âœ“*âœ“Testsâœ“theâœ“webâœ“scrapingâœ“functionality:
âœ“*âœ“-âœ“--scrapeâœ“flagâœ“recognition
âœ“*âœ“-âœ“Webâœ“scraperâœ“initialization
âœ“*âœ“-âœ“Googleâœ“Customâœ“Searchâœ“APIâœ“integration
âœ“*âœ“-âœ“Imageâœ“validationâœ“andâœ“selection
âœ“*âœ“-âœ“Fallbackâœ“toâœ“stockâœ“APIsâœ“whenâœ“scrapingâœ“fails
âœ“*âœ“-âœ“Manifestâœ“generationâœ“withâœ“scrapedâœ“images
âœ“*
âœ“*âœ“Thisâœ“testâœ“requiresâœ“Googleâœ“Customâœ“Searchâœ“APIâœ“credentials.
âœ“*/

//âœ“âŒoadâœ“environmentâœ“variablesâœ“fromâœ“.envâœ“file
importâœ“*âœ“asâœ“dotenvâœ“fromâœ“'dotenv';
dotenv.config();

importâœ“{âœ“describe,âœ“it,âœ“before,âœ“afterâœ“}âœ“fromâœ“'node:test';
importâœ“assertâœ“fromâœ“'node:assert/strict';
importâœ“*âœ“asâœ“fsâœ“fromâœ“'fs/promises';
importâœ“*âœ“asâœ“pathâœ“fromâœ“'path';
importâœ“{âœ“spawnâœ“}âœ“fromâœ“'node:child_process';

//âœ“Testâœ“constants
constâœ“TEST_TIMEOUTâœ“ğŸ“‹âœ“600000;âœ“//âœ“10âœ“minutesâœ“(webâœ“scrapingâœ“canâœ“beâœ“slow)

/**
âœ“*âœ“Helper:âœ“Executeâœ“gatherâœ“commandâœ“withâœ“--scrapeâœ“flag
âœ“*/
asyncâœ“functionâœ“executeGatherWithScrape(
âœ“âœ“projectId:âœ“string,
âœ“âœ“cwd:âœ“stringâœ“ğŸ“‹âœ“process.cwd()
):âœ“PromiseğŸ”{âœ“stdout:âœ“string;âœ“stderr:âœ“string;âœ“exitCode:âœ“numberâœ“}ğŸ§¹âœ“{
âœ“âœ“returnâœ“newâœ“Promise((resolve,âœ“reject)âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“constâœ“procâœ“ğŸ“‹âœ“spawn('tsx',âœ“['cli/commands/gather.ts',âœ“projectId,âœ“'--scrape'],âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“cwd,
âœ“âœ“âœ“âœ“âœ“âœ“env:âœ“{âœ“...process.envâœ“},
âœ“âœ“âœ“âœ“âœ“âœ“stdio:âœ“['ignore',âœ“'pipe',âœ“'pipe'],
âœ“âœ“âœ“âœ“});

âœ“âœ“âœ“âœ“letâœ“stdoutâœ“ğŸ“‹âœ“'';
âœ“âœ“âœ“âœ“letâœ“stderrâœ“ğŸ“‹âœ“'';

âœ“âœ“âœ“âœ“proc.stdout?.on('data',âœ“(data)âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“stdoutâœ“+ğŸ“‹âœ“data.toString();
âœ“âœ“âœ“âœ“});

âœ“âœ“âœ“âœ“proc.stderr?.on('data',âœ“(data)âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“stderrâœ“+ğŸ“‹âœ“data.toString();
âœ“âœ“âœ“âœ“});

âœ“âœ“âœ“âœ“proc.on('close',âœ“(code)âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“resolve({âœ“stdout,âœ“stderr,âœ“exitCode:âœ“codeâœ“||âœ“0âœ“});
âœ“âœ“âœ“âœ“});

âœ“âœ“âœ“âœ“proc.on('error',âœ“(err)âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“reject(err);
âœ“âœ“âœ“âœ“});

âœ“âœ“âœ“âœ“//âœ“Timeoutâœ“afterâœ“10âœ“minutes
âœ“âœ“âœ“âœ“setTimeout(()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“proc.kill();
âœ“âœ“âœ“âœ“âœ“âœ“reject(newâœ“Error('Gatherâœ“commandâœ“timedâœ“outâœ“afterâœ“10âœ“minutes'));
âœ“âœ“âœ“âœ“},âœ“TEST_TIMEOUT);
âœ“âœ“});
}

/**
âœ“*âœ“Helper:âœ“Checkâœ“ifâœ“Googleâœ“Searchâœ“APIâœ“credentialsâœ“areâœ“available
âœ“*/
functionâœ“hasGoogleSearchCredentials():âœ“booleanâœ“{
âœ“âœ“returnâœ“!!(
âœ“âœ“âœ“âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_API_KEYâœ“&&
âœ“âœ“âœ“âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_ENGINE_ID
âœ“âœ“);
}

/**
âœ“*âœ“Helper:âœ“Createâœ“testâœ“projectâœ“directory
âœ“*/
asyncâœ“functionâœ“createTestProject(projectId:âœ“string):âœ“PromiseğŸ”stringğŸ§¹âœ“{
âœ“âœ“constâœ“projectRootâœ“ğŸ“‹âœ“path.join(process.cwd(),âœ“'projects',âœ“projectId);
âœ“âœ“awaitâœ“fs.mkdir(projectRoot,âœ“{âœ“recursive:âœ“trueâœ“});
âœ“âœ“awaitâœ“fs.mkdir(path.join(projectRoot,âœ“'scripts'),âœ“{âœ“recursive:âœ“trueâœ“});
âœ“âœ“awaitâœ“fs.mkdir(path.join(projectRoot,âœ“'assets',âœ“'images'),âœ“{âœ“recursive:âœ“trueâœ“});
âœ“âœ“returnâœ“projectRoot;
}

/**
âœ“*âœ“Helper:âœ“Cleanupâœ“testâœ“project
âœ“*/
asyncâœ“functionâœ“cleanupTestProject(projectRoot:âœ“string):âœ“PromiseğŸ”voidğŸ§¹âœ“{
âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“awaitâœ“fs.rm(projectRoot,âœ“{âœ“recursive:âœ“true,âœ“force:âœ“trueâœ“});
âœ“âœ“}âœ“catchâœ“(error)âœ“{
âœ“âœ“âœ“âœ“//âœ“Ignoreâœ“cleanupâœ“errors
âœ“âœ“}
}

/**
âœ“*âœ“Mockâœ“scriptâœ“dataâœ“forâœ“testing
âœ“*/
constâœ“mockScriptâœ“ğŸ“‹âœ“{
âœ“âœ“segments:âœ“[
âœ“âœ“âœ“âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“id:âœ“'segment-1',
âœ“âœ“âœ“âœ“âœ“âœ“text:âœ“'Aâœ“beautifulâœ“sunsetâœ“overâœ“theâœ“oceanâœ“withâœ“vibrantâœ“orangeâœ“andâœ“purpleâœ“colorsâœ“reflectingâœ“onâœ“theâœ“calmâœ“water.',
âœ“âœ“âœ“âœ“âœ“âœ“wordCount:âœ“18,
âœ“âœ“âœ“âœ“},
âœ“âœ“âœ“âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“id:âœ“'segment-2',
âœ“âœ“âœ“âœ“âœ“âœ“text:âœ“'Mountainsâœ“coveredâœ“inâœ“snowâœ“underâœ“aâœ“clearâœ“blueâœ“sky,âœ“withâœ“pineâœ“treesâœ“inâœ“theâœ“foreground.',
âœ“âœ“âœ“âœ“âœ“âœ“wordCount:âœ“17,
âœ“âœ“âœ“âœ“},
âœ“âœ“],
âœ“âœ“metadata:âœ“{
âœ“âœ“âœ“âœ“totalWords:âœ“35,
âœ“âœ“âœ“âœ“totalSegments:âœ“2,
âœ“âœ“},
};

describe('Stageâœ“5:âœ“Gatherâœ“E2Eâœ“Testâœ“withâœ“--scrape',âœ“{âœ“timeout:âœ“TEST_TIMEOUTâœ“},âœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“letâœ“testProjectId:âœ“string;
âœ“âœ“letâœ“testProjectRoot:âœ“string;

âœ“âœ“before(asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“console.log('\nğŸ”âœ“Startingâœ“Gatherâœ“--scrapeâœ“E2Eâœ“Test...\n');

âœ“âœ“âœ“âœ“//âœ“Checkâœ“forâœ“Googleâœ“Searchâœ“APIâœ“credentials
âœ“âœ“âœ“âœ“ifâœ“(!hasGoogleSearchCredentials())âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âš ï¸âœ“âœ“Missingâœ“Googleâœ“Customâœ“Searchâœ“APIâœ“credentials');
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“âœ“âœ“Requiredâœ“environmentâœ“variables:');
âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“-âœ“GOOGâŒE_CUSTOM_SEARCH_API_KEY:âœ“${process.env.GOOGâŒE_CUSTOM_SEARCH_API_KEYâœ“?âœ“''âœ“:âœ“'âŒ'}`);
âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“-âœ“GOOGâŒE_CUSTOM_SEARCH_ENGINE_ID:âœ“${process.env.GOOGâŒE_CUSTOM_SEARCH_ENGINE_IDâœ“?âœ“''âœ“:âœ“'âŒ'}`);
âœ“âœ“âœ“âœ“âœ“âœ“console.log('\nâš ï¸âœ“âœ“Testsâœ“willâœ“beâœ“skippedâœ“orâœ“useâœ“mockâœ“data\n');
âœ“âœ“âœ“âœ“}âœ“elseâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Googleâœ“Customâœ“Searchâœ“APIâœ“credentialsâœ“found\n');
âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“//âœ“Createâœ“testâœ“project
âœ“âœ“âœ“âœ“testProjectIdâœ“ğŸ“‹âœ“`gather-scrape-test-${Date.now()}`;
âœ“âœ“âœ“âœ“console.log(`ğŸ“‹âš ï¸âœ“Creatingâœ“testâœ“project:âœ“${testProjectId}...`);
âœ“âœ“âœ“âœ“testProjectRootâœ“ğŸ“‹âœ“awaitâœ“createTestProject(testProjectId);

âœ“âœ“âœ“âœ“//âœ“Createâœ“prerequisiteâœ“files
âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“path.join(testProjectRoot,âœ“'selected.json'),
âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify({
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“topic:âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“title:âœ“'Natureâœ“Photography',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“description:âœ“'Beautifulâœ“landscapesâœ“fromâœ“aroundâœ“theâœ“world',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“keywords:âœ“['nature',âœ“'photography',âœ“'landscapes'],
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“},
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“selectedAt:âœ“newâœ“Date().toISOString(),
âœ“âœ“âœ“âœ“âœ“âœ“},âœ“null,âœ“2)
âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“path.join(testProjectRoot,âœ“'refined.json'),
âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify({
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“topic:âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“title:âœ“'Natureâœ“Photography:âœ“Capturingâœ“Earth\'sâœ“Beauty',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“description:âœ“'Exploreâœ“stunningâœ“landscapesâœ“andâœ“naturalâœ“wondersâœ“throughâœ“theâœ“lensâœ“ofâœ“professionalâœ“photographers.',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“targetAudience:âœ“'Photographyâœ“enthusiasts',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“keyPoints:âœ“[
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Sunsetâœ“photographyâœ“techniques',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Mountainâœ“landscapes',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Naturalâœ“lighting',
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“],
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“},
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“refinedAt:âœ“newâœ“Date().toISOString(),
âœ“âœ“âœ“âœ“âœ“âœ“},âœ“null,âœ“2)
âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“path.join(testProjectRoot,âœ“'scripts',âœ“'script-v1.json'),
âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify(mockScript,âœ“null,âœ“2)
âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“console.log(`âœ“Testâœ“projectâœ“created:âœ“${testProjectId}\n`);
âœ“âœ“});

âœ“âœ“after(asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“console.log('\nğŸ§¹âš ï¸âœ“Cleaningâœ“up...');

âœ“âœ“âœ“âœ“ifâœ“(testProjectRoot)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“awaitâœ“cleanupTestProject(testProjectRoot);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Testâœ“projectâœ“cleanedâœ“up\n');
âœ“âœ“âœ“âœ“âœ“âœ“}âœ“catchâœ“(error:âœ“any)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.error('âš ï¸âœ“âœ“Cleanupâœ“error:',âœ“error.message);
âœ“âœ“âœ“âœ“âœ“âœ“}
âœ“âœ“âœ“âœ“}
âœ“âœ“});

âœ“âœ“it('shouldâœ“recognizeâœ“--scrapeâœ“flagâœ“andâœ“initializeâœ“webâœ“scraper',âœ“asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“ifâœ“(!hasGoogleSearchCredentials())âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âš ï¸âœ“âœ“Testâœ“skipped:âœ“Missingâœ“Googleâœ“Searchâœ“APIâœ“credentials');
âœ“âœ“âœ“âœ“âœ“âœ“return;
âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“console.log('ğŸ“‹âœ“Testingâœ“--scrapeâœ“flagâœ“recognition...');

âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“resultâœ“ğŸ“‹âœ“awaitâœ“executeGatherWithScrape(testProjectId);

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“thatâœ“scraperâœ“wasâœ“initializedâœ“(lookâœ“forâœ“logâœ“message)
âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“result.stdout.includes('[GATHER]âœ“Initializingâœ“webâœ“scraper')âœ“||
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“result.stdout.includes('Webâœ“scraperâœ“initialized')âœ“||
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“result.stdout.includes('scrapeâœ“mode'),
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Shouldâœ“logâœ“webâœ“scraperâœ“initialization'
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“--scrapeâœ“flagâœ“recognizedâœ“andâœ“webâœ“scraperâœ“initialized\n');
âœ“âœ“âœ“âœ“}âœ“catchâœ“(error:âœ“any)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.error('âŒâœ“Testâœ“failed:',âœ“error.message);
âœ“âœ“âœ“âœ“âœ“âœ“throwâœ“error;
âœ“âœ“âœ“âœ“}
âœ“âœ“});

âœ“âœ“it('shouldâœ“downloadâœ“scrapedâœ“imagesâœ“andâœ“createâœ“manifest',âœ“asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“ifâœ“(!hasGoogleSearchCredentials())âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âš ï¸âœ“âœ“Testâœ“skipped:âœ“Missingâœ“Googleâœ“Searchâœ“APIâœ“credentials');
âœ“âœ“âœ“âœ“âœ“âœ“return;
âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“console.log('ğŸ“‹âš ï¸âœ“Testingâœ“imageâœ“downloadâœ“andâœ“manifestâœ“creation...');

âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Readâœ“manifest.json
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestPathâœ“ğŸ“‹âœ“path.join(testProjectRoot,âœ“'manifest.json');
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestDataâœ“ğŸ“‹âœ“JSON.parse(awaitâœ“fs.readFile(manifestPath,âœ“'utf-8'));

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Validateâœ“manifestâœ“structure
âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(manifestData.images,âœ“'Manifestâœ“shouldâœ“haveâœ“imagesâœ“array');
âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(Array.isArray(manifestData.images),âœ“'imagesâœ“shouldâœ“beâœ“anâœ“array');

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“ifâœ“anyâœ“imagesâœ“wereâœ“scraped
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“scrapedImagesâœ“ğŸ“‹âœ“manifestData.images.filter(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“(img:âœ“any)âœ“ğŸ“‹ğŸ§¹âœ“img.sourceâœ“ğŸ“‹ğŸ“‹ğŸ“‹âœ“'web-scrape'âœ“||âœ“img.providerâœ“ğŸ“‹ğŸ“‹ğŸ“‹âœ“'gemini-search'
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(scrapedImages.lengthâœ“ğŸ§¹âœ“0)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“âœ“Foundâœ“${scrapedImages.length}âœ“scrapedâœ“image(s)`);

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Validateâœ“scrapedâœ“imageâœ“structure
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“forâœ“(constâœ“imageâœ“ofâœ“scrapedImages)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(image.id,âœ“'Scrapedâœ“imageâœ“shouldâœ“haveâœ“id');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(image.path,âœ“'Scrapedâœ“imageâœ“shouldâœ“haveâœ“path');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.strictEqual(image.source,âœ“'web-scrape',âœ“'Sourceâœ“shouldâœ“beâœ“web-scrape');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.strictEqual(image.provider,âœ“'gemini-search',âœ“'Providerâœ“shouldâœ“beâœ“gemini-search');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(image.sourceUrl,âœ“'Scrapedâœ“imageâœ“shouldâœ“haveâœ“sourceUrl');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(image.tags,âœ“'Scrapedâœ“imageâœ“shouldâœ“haveâœ“tags');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(Array.isArray(image.tags),âœ“'Tagsâœ“shouldâœ“beâœ“anâœ“array');

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Verifyâœ“imageâœ“fileâœ“exists
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“constâœ“imageExistsâœ“ğŸ“‹âœ“awaitâœ“fs.access(image.path).then(()âœ“ğŸ“‹ğŸ§¹âœ“true).catch(()âœ“ğŸ“‹ğŸ§¹âœ“false);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(imageExists,âœ“`Scrapedâœ“imageâœ“fileâœ“shouldâœ“existâœ“atâœ“${image.path}`);

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“-âœ“Imageâœ“${image.id}:âœ“${image.sourceUrl}`);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Scrapedâœ“imagesâœ“validated\n');
âœ“âœ“âœ“âœ“âœ“âœ“}âœ“elseâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“âœ“âœ“âš ï¸âœ“âœ“Noâœ“scrapedâœ“imagesâœ“foundâœ“(mayâœ“haveâœ“fallenâœ“backâœ“toâœ“stock)');

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“ifâœ“fallbackâœ“toâœ“stockâœ“wasâœ“used
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“constâœ“stockImagesâœ“ğŸ“‹âœ“manifestData.images.filter(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“(img:âœ“any)âœ“ğŸ“‹ğŸ§¹âœ“img.sourceâœ“!ğŸ“‹ğŸ“‹âœ“'web-scrape'
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(stockImages.lengthâœ“ğŸ§¹âœ“0)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“ğŸ“Šâœ“âœ“Foundâœ“${stockImages.length}âœ“stockâœ“image(s)âœ“(fallbackâœ“worked)`);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Fallbackâœ“behaviorâœ“validated\n');
âœ“âœ“âœ“âœ“âœ“âœ“}
âœ“âœ“âœ“âœ“}âœ“catchâœ“(error:âœ“any)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.error('âŒâœ“Testâœ“failed:',âœ“error.message);
âœ“âœ“âœ“âœ“âœ“âœ“throwâœ“error;
âœ“âœ“âœ“âœ“}
âœ“âœ“});

âœ“âœ“it('shouldâœ“respectâœ“qualityâœ“criteriaâœ“forâœ“scrapedâœ“images',âœ“asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“ifâœ“(!hasGoogleSearchCredentials())âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.log('âš ï¸âœ“âœ“Testâœ“skipped:âœ“Missingâœ“Googleâœ“Searchâœ“APIâœ“credentials');
âœ“âœ“âœ“âœ“âœ“âœ“return;
âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“console.log('ğŸ”âš ï¸âœ“Testingâœ“qualityâœ“criteriaâœ“validation...');

âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestPathâœ“ğŸ“‹âœ“path.join(testProjectRoot,âœ“'manifest.json');
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestDataâœ“ğŸ“‹âœ“JSON.parse(awaitâœ“fs.readFile(manifestPath,âœ“'utf-8'));

âœ“âœ“âœ“âœ“âœ“âœ“constâœ“scrapedImagesâœ“ğŸ“‹âœ“manifestData.images.filter(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“(img:âœ“any)âœ“ğŸ“‹ğŸ§¹âœ“img.sourceâœ“ğŸ“‹ğŸ“‹ğŸ“‹âœ“'web-scrape'
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(scrapedImages.lengthâœ“ğŸ§¹âœ“0)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“forâœ“(constâœ“imageâœ“ofâœ“scrapedImages)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Readâœ“imageâœ“metadataâœ“ifâœ“available
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(image.metadata)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“minimumâœ“dimensionsâœ“(shouldâœ“beâœ“atâœ“leastâœ“1ğŸ“Š20x1080âœ“basedâœ“onâœ“config)
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(image.metadata.widthâœ“&&âœ“image.metadata.height)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“image.metadata.widthâœ“ğŸ§¹ğŸ“‹âœ“1ğŸ“Š20âœ“||âœ“image.metadata.heightâœ“ğŸ§¹ğŸ“‹âœ“1080,
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“`Scrapedâœ“imageâœ“shouldâœ“meetâœ“minimumâœ“dimensionsâœ“(gotâœ“${image.metadata.width}x${image.metadata.height})`
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“âœ“Imageâœ“dimensions:âœ“${image.metadata.width}x${image.metadata.height}`);
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“aspectâœ“ratioâœ“ifâœ“available
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(image.metadata.aspectRatio)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“constâœ“targetRatioâœ“ğŸ“‹âœ“16âœ“/âœ“ğŸ“Š;
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“constâœ“toleranceâœ“ğŸ“‹âœ“0.3;
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“constâœ“ratioDiffâœ“ğŸ“‹âœ“Math.abs(image.metadata.aspectRatioâœ“-âœ“targetRatio);

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“ğŸ“Šâœ“âœ“Aspectâœ“ratio:âœ“${image.metadata.aspectRatio.toFixed(2)}âœ“(target:âœ“${targetRatio.toFixed(2)})`);

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Note:âœ“Thisâœ“mightâœ“failâœ“ifâœ“scraperâœ“allowsâœ“imagesâœ“outsideâœ“tolerance
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“//âœ“That'sâœ“acceptableâœ“asâœ“longâœ“asâœ“theyâœ“meetâœ“minimumâœ“quality
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Qualityâœ“criteriaâœ“validated\n');
âœ“âœ“âœ“âœ“âœ“âœ“}âœ“elseâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“âœ“âœ“âš ï¸âœ“âœ“Noâœ“scrapedâœ“imagesâœ“toâœ“validateâœ“quality\n');
âœ“âœ“âœ“âœ“âœ“âœ“}
âœ“âœ“âœ“âœ“}âœ“catchâœ“(error:âœ“any)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.error('âŒâœ“Testâœ“failed:',âœ“error.message);
âœ“âœ“âœ“âœ“âœ“âœ“throwâœ“error;
âœ“âœ“âœ“âœ“}
âœ“âœ“});

âœ“âœ“it('shouldâœ“handleâœ“missingâœ“Googleâœ“APIâœ“credentialsâœ“gracefully',âœ“asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“console.log('ğŸ“‹âœ“Testingâœ“gracefulâœ“handlingâœ“ofâœ“missingâœ“credentials...');

âœ“âœ“âœ“âœ“//âœ“Temporarilyâœ“removeâœ“credentials
âœ“âœ“âœ“âœ“constâœ“originalApiKeyâœ“ğŸ“‹âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_API_KEY;
âœ“âœ“âœ“âœ“constâœ“originalEngineIdâœ“ğŸ“‹âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_ENGINE_ID;

âœ“âœ“âœ“âœ“deleteâœ“process.env.GOOGâŒE_CUSTOM_SEARCH_API_KEY;
âœ“âœ“âœ“âœ“deleteâœ“process.env.GOOGâŒE_CUSTOM_SEARCH_ENGINE_ID;

âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Createâœ“aâœ“newâœ“testâœ“projectâœ“forâœ“thisâœ“scenario
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“testIdâœ“ğŸ“‹âœ“`gather-scrape-noapi-${Date.now()}`;
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“testRootâœ“ğŸ“‹âœ“awaitâœ“createTestProject(testId);

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Createâœ“prerequisiteâœ“files
âœ“âœ“âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“path.join(testRoot,âœ“'selected.json'),
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify({âœ“topic:âœ“{âœ“title:âœ“'Test',âœ“description:âœ“'Test',âœ“keywords:âœ“[]âœ“},âœ“selectedAt:âœ“newâœ“Date().toISOString()âœ“},âœ“null,âœ“2)
âœ“âœ“âœ“âœ“âœ“âœ“);
âœ“âœ“âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“path.join(testRoot,âœ“'refined.json'),
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify({âœ“topic:âœ“{âœ“title:âœ“'Test',âœ“description:âœ“'Test',âœ“targetAudience:âœ“'Test',âœ“keyPoints:âœ“[]âœ“},âœ“refinedAt:âœ“newâœ“Date().toISOString()âœ“},âœ“null,âœ“2)
âœ“âœ“âœ“âœ“âœ“âœ“);
âœ“âœ“âœ“âœ“âœ“âœ“awaitâœ“fs.writeFile(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“path.join(testRoot,âœ“'scripts',âœ“'script-v1.json'),
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“JSON.stringify({âœ“segments:âœ“[{âœ“id:âœ“'seg-1',âœ“text:âœ“'Testâœ“segment.',âœ“wordCount:âœ“2âœ“}],âœ“metadata:âœ“{âœ“totalWords:âœ“2,âœ“totalSegments:âœ“1âœ“}âœ“},âœ“null,âœ“2)
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“constâœ“resultâœ“ğŸ“‹âœ“awaitâœ“executeGatherWithScrape(testId);

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Shouldâœ“either:
âœ“âœ“âœ“âœ“âœ“âœ“//âœ“1.âœ“âŒogâœ“aâœ“warningâœ“aboutâœ“missingâœ“credentialsâœ“andâœ“fallâœ“back
âœ“âœ“âœ“âœ“âœ“âœ“//âœ“2.âœ“Orâœ“failâœ“gracefullyâœ“withâœ“anâœ“errorâœ“message
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“hasWarningâœ“ğŸ“‹âœ“result.stdout.includes('âš ï¸')âœ“||âœ“result.stdout.includes('warning')âœ“||âœ“result.stderr.includes('GOOGâŒE_CUSTOM_SEARCH');
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“hasFallbackâœ“ğŸ“‹âœ“result.stdout.includes('Fallingâœ“back')âœ“||âœ“result.stdout.includes('fallback');

âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“hasWarningâœ“||âœ“hasFallbackâœ“||âœ“result.exitCodeâœ“!ğŸ“‹ğŸ“‹âœ“0,
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Shouldâœ“handleâœ“missingâœ“credentialsâœ“gracefullyâœ“(warn,âœ“fallback,âœ“orâœ“exitâœ“withâœ“error)'
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Gracefullyâœ“handledâœ“missingâœ“credentials\n');

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Cleanup
âœ“âœ“âœ“âœ“âœ“âœ“awaitâœ“cleanupTestProject(testRoot);
âœ“âœ“âœ“âœ“}âœ“finallyâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Restoreâœ“credentials
âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(originalApiKey)âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_API_KEYâœ“ğŸ“‹âœ“originalApiKey;
âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(originalEngineId)âœ“process.env.GOOGâŒE_CUSTOM_SEARCH_ENGINE_IDâœ“ğŸ“‹âœ“originalEngineId;
âœ“âœ“âœ“âœ“}
âœ“âœ“});

âœ“âœ“it('shouldâœ“fallâœ“backâœ“toâœ“stockâœ“APIsâœ“whenâœ“scrapingâœ“findsâœ“insufficientâœ“candidates',âœ“asyncâœ“()âœ“ğŸ“‹ğŸ§¹âœ“{
âœ“âœ“âœ“âœ“console.log('ğŸ“‹âœ“Testingâœ“fallbackâœ“toâœ“stockâœ“APIs...');

âœ“âœ“âœ“âœ“//âœ“Thisâœ“testâœ“isâœ“implicitâœ“-âœ“ifâœ“scrapingâœ“failsâœ“toâœ“findâœ“enoughâœ“candidates,
âœ“âœ“âœ“âœ“//âœ“theâœ“systemâœ“shouldâœ“automaticallyâœ“fallâœ“backâœ“toâœ“stockâœ“APIs

âœ“âœ“âœ“âœ“tryâœ“{
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestPathâœ“ğŸ“‹âœ“path.join(testProjectRoot,âœ“'manifest.json');
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestExistsâœ“ğŸ“‹âœ“awaitâœ“fs.access(manifestPath).then(()âœ“ğŸ“‹ğŸ§¹âœ“true).catch(()âœ“ğŸ“‹ğŸ§¹âœ“false);

âœ“âœ“âœ“âœ“âœ“âœ“ifâœ“(!manifestExists)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“âœ“âœ“âš ï¸âœ“âœ“Manifestâœ“notâœ“createdâœ“yet,âœ“skippingâœ“fallbackâœ“test');
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“return;
âœ“âœ“âœ“âœ“âœ“âœ“}

âœ“âœ“âœ“âœ“âœ“âœ“constâœ“manifestDataâœ“ğŸ“‹âœ“JSON.parse(awaitâœ“fs.readFile(manifestPath,âœ“'utf-8'));

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Shouldâœ“haveâœ“SOMEâœ“images,âœ“eitherâœ“scrapedâœ“orâœ“fromâœ“stock
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“totalImagesâœ“ğŸ“‹âœ“manifestData.images?.lengthâœ“||âœ“0;
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“totalVideosâœ“ğŸ“‹âœ“manifestData.videos?.lengthâœ“||âœ“0;

âœ“âœ“âœ“âœ“âœ“âœ“assert.ok(
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“totalImagesâœ“ğŸ§¹âœ“0âœ“||âœ“totalVideosâœ“ğŸ§¹âœ“0,
âœ“âœ“âœ“âœ“âœ“âœ“âœ“âœ“'Shouldâœ“haveâœ“downloadedâœ“someâœ“mediaâœ“(eitherâœ“scrapedâœ“orâœ“stockâœ“fallback)'
âœ“âœ“âœ“âœ“âœ“âœ“);

âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“ğŸ“Šâœ“âœ“Totalâœ“media:âœ“${totalImages}âœ“images,âœ“${totalVideos}âœ“videos`);

âœ“âœ“âœ“âœ“âœ“âœ“//âœ“Checkâœ“sources
âœ“âœ“âœ“âœ“âœ“âœ“constâœ“sourcesâœ“ğŸ“‹âœ“newâœ“Set(manifestData.images?.map((img:âœ“any)âœ“ğŸ“‹ğŸ§¹âœ“img.source)âœ“||âœ“[]);
âœ“âœ“âœ“âœ“âœ“âœ“console.log(`âœ“âœ“âœ“ğŸ“Šâœ“âœ“Imageâœ“sources:âœ“${Array.from(sources).join(',âœ“')}`);

âœ“âœ“âœ“âœ“âœ“âœ“console.log('âœ“Fallbackâœ“mechanismâœ“workingâœ“(hasâœ“mediaâœ“fromâœ“someâœ“source)\n');
âœ“âœ“âœ“âœ“}âœ“catchâœ“(error:âœ“any)âœ“{
âœ“âœ“âœ“âœ“âœ“âœ“console.error('âŒâœ“Testâœ“failed:',âœ“error.message);
âœ“âœ“âœ“âœ“âœ“âœ“throwâœ“error;
âœ“âœ“âœ“âœ“}
âœ“âœ“});
});

console.log('\nğŸ“‹âš ï¸âœ“Note:âœ“Theseâœ“E2Eâœ“testsâœ“require:');
console.log('âœ“âœ“âœ“-âœ“GOOGâŒE_CUSTOM_SEARCH_API_KEYâœ“environmentâœ“variable');
console.log('âœ“âœ“âœ“-âœ“GOOGâŒE_CUSTOM_SEARCH_ENGINE_IDâœ“environmentâœ“variable');
console.log('âœ“âœ“âœ“-âœ“Geminiâœ“AIâœ“providerâœ“credentialsâœ“(forâœ“queryâœ“generationâœ“andâœ“selection)');
console.log('âœ“âœ“âœ“-âœ“Internetâœ“connectionâœ“forâœ“APIâœ“calls');
console.log('\nâœ“âœ“âœ“Runâœ“with:âœ“npmâœ“testâœ“tests/e2e/stage-gather-scrape.test.ts\n');
